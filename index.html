<script>
const NB_SERVOS = 5;
const logEl = document.getElementById('log');

function log(msg) {
  const line = document.createElement('div');
  line.textContent = msg;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

// --- Nouveaux états ON/OFF par servo ---
const servoEnabled = Array(NB_SERVOS).fill(true);

// Création sliders + boutons ON/OFF
const slidersDiv = document.getElementById('sliders');
const lastValues = Array(NB_SERVOS).fill(90);

for (let i = 0; i < NB_SERVOS; i++) {
  const row = document.createElement('div');
  row.className = 'row';

  const label = document.createElement('div');
  label.textContent = 'Servo ' + i;
  label.style.width = '70px';

  const input = document.createElement('input');
  input.type = 'range';
  input.min = 0;
  input.max = 180;
  input.value = 90;
  input.className = 'slider';
  input.dataset.index = i;

  const val = document.createElement('div');
  val.className = 'val';
  val.textContent = input.value;

  // --- Bouton ON/OFF ---
  const toggle = document.createElement('button');
  toggle.textContent = "ON";
  toggle.dataset.index = i;

  toggle.addEventListener('click', (e) => {
    const idx = parseInt(e.target.dataset.index);
    servoEnabled[idx] = !servoEnabled[idx];
    toggle.textContent = servoEnabled[idx] ? "ON" : "OFF";
    log(`Servo ${idx} -> ${servoEnabled[idx] ? "activé" : "désactivé"}`);
  });

  input.addEventListener('input', (e) => {
    const idx = parseInt(e.target.dataset.index);
    const angle = parseInt(e.target.value);
    val.textContent = angle;
    lastValues[idx] = angle;

    if (servoEnabled[idx] && window.wokwi?.board) {
      window.wokwi.board.servo(idx, angle);
    }
    log(`Servo ${idx} -> ${angle}`);
  });

  row.appendChild(label);
  row.appendChild(input);
  row.appendChild(val);
  row.appendChild(toggle);
  slidersDiv.appendChild(row);
}

// Boutons cycle
let cycleActive = false;
let cycleDir = 1;
let cycleAngle = 0;
let cycleInterval = null;

document.getElementById('btnCycleOn').addEventListener('click', () => {
  if (cycleActive) return;
  cycleActive = true;
  cycleAngle = 0;
  cycleDir = 1;

  cycleInterval = setInterval(() => {
    for (let i = 0; i < NB_SERVOS; i++) {
      if (!servoEnabled[i]) continue;

      lastValues[i] = cycleAngle;

      const slider = document.querySelector(`input[data-index="${i}"]`);
      slider.value = cycleAngle;
      slider.nextElementSibling.textContent = cycleAngle;

      if (window.wokwi?.board) {
        window.wokwi.board.servo(i, cycleAngle);
      }
    }

    cycleAngle += 5 * cycleDir;
    if (cycleAngle >= 180) cycleDir = -1;
    if (cycleAngle <= 0) cycleDir = 1;

  }, 100);

  log("Cycle démarré");
});

document.getElementById('btnCycleOff').addEventListener('click', () => {
  cycleActive = false;
  if (cycleInterval) clearInterval(cycleInterval);
  log("Cycle arrêté");
});

document.getElementById('btnAll45').addEventListener('click', () => {
  for (let i = 0; i < NB_SERVOS; i++) {
    lastValues[i] = 45;

    const slider = document.querySelector(`input[data-index="${i}"]`);
    slider.value = 45;
    slider.nextElementSibling.textContent = 45;

    if (servoEnabled[i] && window.wokwi?.board) {
      window.wokwi.board.servo(i, 45);
    }
  }
  log("Tous les servos à 45° (actifs seulement)");
});
</script>
